<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AA Farkle Scorer">
    <meta name="theme-color" content="#667eea">
    <title>AA Farkle Scorer</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%237c3aed' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>üé≤</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .round-info {
            color: #6b7280;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-add {
            background: #667eea;
            color: white;
            min-width: 60px;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9fafb;
            padding: 14px;
            border-radius: 12px;
        }

        .player-name {
            font-weight: 600;
            color: #1f2937;
        }

        .btn-remove {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .player-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .player-card.leader {
            box-shadow: 0 0 0 3px #fbbf24;
        }

        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-position {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }

        .position-normal {
            background: #667eea;
        }

        .position-leader {
            background: #fbbf24;
        }

        .player-details h3 {
            font-size: 18px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .player-score {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .score-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .running-total {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            text-align: center;
        }

        .running-total-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .running-total-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .running-total-value.farkle {
            color: #dc2626;
        }

        .running-total-value.zero {
            color: #9ca3af;
        }

        .score-history {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        .history-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .history-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip {
            background: #ede9fe;
            color: #6b21a8;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .chip-farkle {
            background: #fee2e2;
            color: #dc2626;
        }

        .winner-banner {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .winner-banner h2 {
            font-size: 24px;
            color: #92400e;
            margin-top: 8px;
        }

        .final-round-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            color: white;
        }

        .final-round-banner h2 {
            font-size: 18px;
            font-weight: bold;
            margin-top: 8px;
        }

        .player-finished {
            opacity: 0.6;
        }

        .player-finished-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .hidden {
            display: none;
        }

        .trophy {
            font-size: 32px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen">
            <div class="card">
                <div class="header">
                    <h1>
                        <span class="trophy">üé≤</span>
                        AA Farkle Scorer
                    </h1>
                </div>

                <div class="input-group">
                    <label>Add Players (minimum 2)</label>
                    <div class="input-row">
                        <input type="text" id="playerNameInput" placeholder="Player name">
                        <button class="btn btn-add" onclick="addPlayer()">Add</button>
                    </div>
                </div>

                <div id="playerList" class="player-list">
                    <div class="empty-state">No players added yet</div>
                </div>

                <button class="btn btn-primary" id="startBtn" onclick="startGame()" disabled>
                    Start Game
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <div class="card">
                <div class="header">
                    <h1>
                        <span class="trophy">üèÜ</span>
                        AA Farkle Scorer
                    </h1>
                    <div class="round-info">
                        Target: 10,000 points
                    </div>
                </div>

                <button class="btn btn-danger" onclick="resetGame()">
                    üîÑ New Game
                </button>
            </div>

            <div id="winnerBanner" class="winner-banner hidden">
                <div class="trophy">üéâ</div>
                <h2 id="winnerText"></h2>
            </div>

            <div id="finalRoundBanner" class="final-round-banner hidden">
                <div class="trophy">‚ö†Ô∏è</div>
                <h2 id="finalRoundText"></h2>
            </div>

            <div id="gamePlayerList"></div>
        </div>
    </div>

    <script>
        let players = [];
        let winner = null;
        let firstToFinish = null;
        let finalRound = false;
        let playersFinished = new Set();
        const WINNING_SCORE = 10000;

        // Add player
        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            
            if (name) {
                players.push({
                    id: Date.now(),
                    name: name,
                    scores: [],
                    total: 0
                });
                input.value = '';
                renderPlayerList();
                updateStartButton();
            }
        }

        // Remove player
        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            renderPlayerList();
            updateStartButton();
        }

        // Render player list in setup
        function renderPlayerList() {
            const list = document.getElementById('playerList');
            
            if (players.length === 0) {
                list.innerHTML = '<div class="empty-state">No players added yet</div>';
            } else {
                list.innerHTML = players.map(player => `
                    <div class="player-item">
                        <span class="player-name">${player.name}</span>
                        <button class="btn-remove" onclick="removePlayer(${player.id})">Remove</button>
                    </div>
                `).join('');
            }
        }

        // Update start button
        function updateStartButton() {
            const btn = document.getElementById('startBtn');
            btn.disabled = players.length < 2;
        }

        // Start game
        function startGame() {
            if (players.length >= 2) {
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                renderGamePlayers();
                
                // Focus on first player's input
                setTimeout(() => {
                    const firstInput = document.getElementById(`score-${players[0].id}`);
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 200);
            }
        }

        // Update running total display
        function updateRunningTotal(playerId) {
            const input = document.getElementById(`score-${playerId}`);
            const display = document.getElementById(`total-${playerId}`);
            const inputValue = input.value.trim();
            
            if (inputValue === '') {
                display.innerHTML = '<div class="running-total-label">Turn Total</div><div class="running-total-value zero">---</div>';
                return;
            }
            
            // Split by spaces or commas and parse all numbers
            const scores = inputValue.split(/[\s,]+/).map(s => parseInt(s.trim())).filter(s => !isNaN(s));
            
            if (scores.length === 0) {
                display.innerHTML = '<div class="running-total-label">Turn Total</div><div class="running-total-value zero">---</div>';
                return;
            }
            
            // Check if ANY entry is a 0 - this means Farkle!
            if (scores.includes(0)) {
                display.innerHTML = '<div class="running-total-label">Turn Total</div><div class="running-total-value farkle">FARKLE!</div>';
                return;
            }
            
            // Calculate total (all positive scores)
            const total = scores.reduce((sum, score) => sum + score, 0);
            
            if (total === 0) {
                display.innerHTML = '<div class="running-total-label">Turn Total</div><div class="running-total-value zero">0</div>';
            } else {
                display.innerHTML = `<div class="running-total-label">Turn Total</div><div class="running-total-value">${total.toLocaleString()}</div>`;
            }
        }

        // Focus on next player's input
        function focusNextPlayer(currentPlayerId) {
            const currentIndex = players.findIndex(p => p.id === currentPlayerId);
            
            // Find next player who hasn't finished (if in final round)
            for (let i = 1; i <= players.length; i++) {
                const nextIndex = (currentIndex + i) % players.length;
                const nextPlayer = players[nextIndex];
                
                // Skip players who have finished in final round
                if (!finalRound || !playersFinished.has(nextPlayer.id)) {
                    const nextInput = document.getElementById(`score-${nextPlayer.id}`);
                    if (nextInput) {
                        setTimeout(() => nextInput.focus(), 100);
                    }
                    break;
                }
            }
        }

        // Add score (handles multiple entries from same round)
        function addScore(playerId) {
            const input = document.getElementById(`score-${playerId}`);
            const inputValue = input.value.trim();
            
            if (inputValue === '') {
                return;
            }
            
            const player = players.find(p => p.id === playerId);
            
            // Split by spaces or commas and parse all numbers
            const scores = inputValue.split(/[\s,]+/).map(s => parseInt(s.trim())).filter(s => !isNaN(s));
            
            if (scores.length === 0) {
                return;
            }
            
            // If ANY entry is a 0, it's a Farkle - player loses the entire turn
            if (scores.includes(0)) {
                player.scores.push(0);
                input.value = '';
                updateRunningTotal(playerId);
                
                // Mark this player as finished if in final round
                if (finalRound) {
                    playersFinished.add(playerId);
                    checkGameEnd();
                }
                
                renderGamePlayers();
                focusNextPlayer(playerId);
                return;
            }
            
            // Calculate total for this round (sum all scores)
            const roundTotal = scores.reduce((sum, score) => sum + score, 0);
            
            // Check minimum score of 500 for first NON-ZERO score
            const hasNonZeroScore = player.scores.some(s => s > 0);
            if (!hasNonZeroScore && roundTotal < 500) {
                alert(`First score must be at least 500 points! Your turn total is ${roundTotal}. (Include a 0 for a Farkle)`);
                return;
            }
            
            if (roundTotal > 0) {
                player.scores.push(roundTotal);
                player.total += roundTotal;
                
                // Check if this player reached 10,000 first
                if (!finalRound && player.total >= WINNING_SCORE) {
                    firstToFinish = player;
                    finalRound = true;
                    playersFinished.add(playerId);
                    showFinalRound();
                } else if (finalRound) {
                    // Mark this player as finished in final round
                    playersFinished.add(playerId);
                    checkGameEnd();
                }
            }
            
            input.value = '';
            updateRunningTotal(playerId);
            renderGamePlayers();
            focusNextPlayer(playerId);
        }
        
        // Show final round notification
        function showFinalRound() {
            const banner = document.getElementById('finalRoundBanner');
            const text = document.getElementById('finalRoundText');
            text.textContent = `${firstToFinish.name} has reached ${firstToFinish.total.toLocaleString()} points! All other players get one more turn.`;
            banner.classList.remove('hidden');
        }
        
        // Check if game should end
        function checkGameEnd() {
            // Check if all other players have had their final turn
            const allPlayersFinished = players.every(p => playersFinished.has(p.id));
            
            if (allPlayersFinished && finalRound) {
                // Find the winner (highest score)
                const maxScore = Math.max(...players.map(p => p.total));
                const winningPlayer = players.find(p => p.total === maxScore);
                winner = winningPlayer.name;
                showWinner();
            }
        }

        // Undo last score
        function undoScore(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player.scores.length > 0) {
                const removedScore = player.scores.pop();
                if (removedScore > 0) {
                    player.total -= removedScore;
                }
                
                // If in final round and this player had finished, unmark them
                if (finalRound && playersFinished.has(playerId)) {
                    playersFinished.delete(playerId);
                    // Hide winner banner if it was showing
                    document.getElementById('winnerBanner').classList.add('hidden');
                    winner = null;
                }
                
                // If this was the player who triggered final round and they go below 10,000
                if (firstToFinish && firstToFinish.id === playerId && player.total < WINNING_SCORE) {
                    // Reset final round
                    finalRound = false;
                    firstToFinish = null;
                    playersFinished.clear();
                    document.getElementById('finalRoundBanner').classList.add('hidden');
                }
                
                renderGamePlayers();
            }
        }

        // Show winner
        function showWinner() {
            document.getElementById('winnerBanner').classList.remove('hidden');
            document.getElementById('winnerText').textContent = `${winner} wins!`;
        }

        // Render game players
        function renderGamePlayers() {
            const list = document.getElementById('gamePlayerList');
            const maxScore = Math.max(...players.map(p => p.total), 0);
            
            list.innerHTML = players.map((player, index) => {
                const isLeader = player.total === maxScore && player.total > 0;
                const hasFinished = finalRound && playersFinished.has(player.id);
                
                return `
                    <div class="player-card ${isLeader ? 'leader' : ''} ${hasFinished ? 'player-finished' : ''}">
                        <div class="player-header">
                            <div class="player-info">
                                <div class="player-position ${isLeader ? 'position-leader' : 'position-normal'}">
                                    ${index + 1}
                                </div>
                                <div class="player-details">
                                    <h3>${player.name} ${hasFinished ? '<span class="player-finished-badge">‚úì Done</span>' : ''}</h3>
                                    <div class="player-score">${player.total.toLocaleString()}</div>
                                </div>
                            </div>
                            ${isLeader ? '<span class="trophy">üèÜ</span>' : ''}
                        </div>
                        
                        ${!hasFinished ? `
                            <div class="running-total" id="total-${player.id}">
                                <div class="running-total-label">Turn Total</div>
                                <div class="running-total-value zero">---</div>
                            </div>
                            
                            <div class="score-controls">
                                <input 
                                    type="text" 
                                    id="score-${player.id}" 
                                    placeholder="50 100 150 (add 0 if you Farkle)"
                                    oninput="updateRunningTotal(${player.id})"
                                    onkeypress="if(event.key==='Enter') addScore(${player.id})"
                                >
                                <button class="btn btn-success" onclick="addScore(${player.id})">Add</button>
                                <button 
                                    class="btn btn-warning" 
                                    onclick="undoScore(${player.id})"
                                    ${player.scores.length === 0 ? 'disabled' : ''}
                                >
                                    Undo
                                </button>
                            </div>
                        ` : '<div style="text-align: center; padding: 20px; color: #10b981; font-weight: 600;">Final turn complete!</div>'}
                        
                        ${player.scores.length > 0 ? `
                            <div class="score-history">
                                <div class="history-label">Score History:</div>
                                <div class="history-chips">
                                    ${player.scores.map((s, idx) => `<span class="chip ${s === 0 ? 'chip-farkle' : ''}">${s === 0 ? 'R' + (idx + 1) + ': Farkle' : 'R' + (idx + 1) + ': ' + s.toLocaleString()}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Reset game
        function resetGame() {
            if (confirm('Start a new game? This will reset all scores.')) {
                players = [];
                winner = null;
                firstToFinish = null;
                finalRound = false;
                playersFinished = new Set();
                
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('setupScreen').classList.remove('hidden');
                document.getElementById('winnerBanner').classList.add('hidden');
                document.getElementById('finalRoundBanner').classList.add('hidden');
                renderPlayerList();
                updateStartButton();
            }
        }

        // Handle Enter key on player name input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
        });
    </script>
</body>
</html>
